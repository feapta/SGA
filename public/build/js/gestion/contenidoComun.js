var arraytrabajos=[],cambio=0,jsonrecibido=[],idparte=document.querySelector("#idparte").value,indicefila=-1,arrayfilas=[],totalhorastrabajo=0,totalhorasmaquina=0,totalcantpro=0;const Objetotrabajo={id:"",idparte:"",indicefila:"",idempleado:"",idtrabajo:"",horastrabajo:"",idmaquina:"",horasmaquina:"",idproducto:"",cantpro:""};function clientesCabecera(e){const a=document.createElement("option");a.classList.add("empleadoselecionado"),a.textContent=jsonrecibido[0][0].nombreclienteapp??"Selecione un cliente",a.value=jsonrecibido[0][0].idclienteapp??null,a.selected=!0,document.querySelector("#idclienteapp").appendChild(a),jsonrecibido[e].forEach(e=>{const{idclienteapp:a,nombrecliente:o}=e,t=document.createElement("option");t.classList.add("optionclienteapp"),t.textContent=o,t.value=a,document.querySelector("#idclienteapp").appendChild(t)});document.querySelector("#idclienteapp").addEventListener("change",fincas)}async function fincas(e,a){const o=document.querySelector("#idclienteapp").value,t=new FormData;t.append("idclienteapp",o);try{const o="/partes/fincas",c=await fetch(o,{method:"POST",body:t}),n=await c.json();n&&creafinca(n,e,a)}catch(e){console.log(e)}}function creafinca(e,a,o){$(".fincaPlaceholder").remove(),$("#idfinca").find("option").not(":first").remove();const t=document.createElement("option");t.classList.add("fincaselecionado"),t.textContent="Selecione una finca",t.value=a??null,t.selected=!0,document.querySelector("#idfinca").appendChild(t),e.forEach(e=>{const{id:a,nombre:o}=e,t=document.createElement("option");t.value=a,t.textContent=o,document.querySelector("#idfinca").appendChild(t)})}function empleadosCabecera(e){const a=document.createElement("option");a.classList.add("empleadoselecionado"),a.textContent="Selecione empleado para aÃ±adir nuevo trabajo",a.selected=!0,document.querySelector("#selectEmpleadoCabecera").appendChild(a),jsonrecibido[e].forEach(e=>{const{idempleados:a,nombreempleados:o}=e,t=document.createElement("option");t.classList.add("empleadoselecionado"),t.textContent=o,t.value=a,document.querySelector("#selectEmpleadoCabecera").appendChild(t)})}function escuchaBotonOk(){document.querySelectorAll(".ok").forEach(e=>{e.addEventListener("click",cambioBoton)})}function cambioBoton(e){const a=e.target.parentElement.parentElement,o=a.querySelector(".imgok");if(o.classList.contains("rojo")){o.src="/build/img/lapiz.png",o.classList.add("verde"),o.classList.remove("rojo");a.querySelectorAll(".cambiocolor").forEach(e=>{e.disabled=!0}),modificarObjeto(e)}else{o.classList.remove("verde"),o.classList.add("rojo"),o.src="/build/img/ok_rojo.png";a.querySelectorAll(".cambiocolor").forEach(e=>{e.disabled=!1}),botonDescactiva()}}function filaObjeto(e,a,o,t){indicefila++;let c=document.querySelector("#selectEmpleadoCabecera").value,n=$("#selectEmpleadoCabecera option:selected").text();const r=jsonrecibido[e],i=jsonrecibido[a],l=jsonrecibido[o],d=jsonrecibido[t],u=$("#selectEmpleadoCabecera option:selected").text(),s=document.querySelector("#selectEmpleadoCabecera").value,p=document.createElement("td"),m=document.createElement("select");m.classList.add("selectempleado"),m.classList.add("cambiocolor");const b=document.createElement("option");b.classList.add("empleadoselecionado"),b.textContent=u,b.value=s,m.appendChild(b),p.appendChild(m);const h=Id(""),f=Indicefilas(indicefila),y=Idparte(idparte),q=Empleados(r,c,n,!1),v=Trabajos(i,"","",!1),S=Horastrabajo("",!1),j=Maquinas(l,"","",!1),C=Horasmaquinas("",!1),E=Productos(d,"","",!1),g=Cantidadproductos("",!1),L=lapiz("/build/img/ok_rojo.png","rojo"),O=papelera(),w=document.createElement("tr");w.appendChild(h),w.appendChild(y),w.appendChild(f),w.appendChild(q),w.appendChild(v),w.appendChild(S),w.appendChild(j),w.appendChild(C),w.appendChild(E),w.appendChild(g),w.appendChild(L),w.appendChild(O),document.querySelector("#cuerpo").appendChild(w);const x={id:"",idparte:"",indicefila:indicefila,idempleado:s,idtrabajo:"",horastrabajo:"",idmaquina:"",horasmaquina:"",idproducto:"",cantpro:""};arraytrabajos=[...arraytrabajos,x],escuchaBotonOk(),escuchaBotonEliminar(),escuchaBotonGuardar()}function modificarObjeto(e){const a=e.target.parentElement.parentElement,o=a.querySelector("#indicefila").value;arraytrabajos[o]={id:a.querySelector("#idpartetrabajo").value,idparte:a.querySelector("#idparte").value,indicefila:a.querySelector("#indicefila").value,idempleado:a.querySelector(".selectempleado").value,idtrabajo:a.querySelector(".selecttrabajo").value,horastrabajo:a.querySelector(".horastrabajo").value,idmaquina:a.querySelector(".selectmaquina").value,horasmaquina:a.querySelector(".horasmaquina").value,idproducto:a.querySelector(".selectproducto").value,cantpro:a.querySelector(".cantidadproducto").value};const t=arraytrabajos.reduce((e,a)=>Number(e)+Number(a.horastrabajo),0),c=arraytrabajos.reduce((e,a)=>Number(e)+Number(a.horasmaquina),0),n=arraytrabajos.reduce((e,a)=>Number(e)+Number(a.cantpro),0);console.log(t),console.log(c),console.log(n),document.querySelector(".totalhorastrabajo").value=t,document.querySelector(".totalhorasmaquina").value=c,document.querySelector(".totalcantidadproducto").value=n,botonActiva()}function nuevo(e){location.href=e}function escuchaBotonEliminar(){document.querySelectorAll(".imgpapelera").forEach(e=>{e.addEventListener("click",eliminarfila)})}function eliminarfila(e){const a=e.target.parentElement.parentElement;let o=a.querySelector("#indicefila").value;arraytrabajos.splice(o,1),$(a).closest("tr").remove(),console.log(arraytrabajos),indicefila--}async function guardarParte(){const e=document.querySelector("#idparte").value,a=document.querySelector("#idclienteS").value,o=document.querySelector("#autonumero").value,t=document.querySelector("#fecha").value,c=document.querySelector("#idclienteapp").value,n=document.querySelector("#idfinca").value,r=document.querySelector(".totalhorastrabajo").value,i=document.querySelector(".totalhorasmaquina").value,l=document.querySelector(".totalcantidadproducto").value,d=new FormData;e&&d.append("id",e),d.append("idclienteapp",c),d.append("idclientesistemar",a),d.append("autonumero",o),d.append("fecha",t),d.append("idfinca",n),d.append("horastrabajo",r),d.append("horasmaquina",i),d.append("cantpro",l),d.append("trabajos",JSON.stringify(arraytrabajos));try{const e="/partes/guardar",o=await fetch(e,{method:"POST",body:d});await o.json()&&(Swal.fire({icon:"success",title:"Parte actualizado correctamente",showConfirmButton:!1,timer:1500}),setTimeout(()=>{window.location.href="/partes?idclienteS="+a},1500))}catch(e){console.log(e)}}function escuchaBotonGuardar(){document.querySelector(".cambiocolor").addEventListener("change",botonDescactiva)}function botonDescactiva(){const e=document.querySelector(".botonGuardar");e.disabled=!0,e.classList.add("botonOscuro")}function botonActiva(){const e=document.querySelector(".botonGuardar");e.disabled=!1,e.classList.remove("botonOscuro")}